<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Error Details</title>
    <style>
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Test Error Details</h1>
    <pre id="output"></pre>
    
    <!-- Load all dependencies like index.html does -->
    <script src="js/browser-compatibility.js" defer></script>
    <script src="js/performance-optimizer.js" defer></script>
    <script src="js/data-normalizer.js" defer></script>
    <script src="js/data-loader.js" defer></script>
    <script src="js/data-validator.js" defer></script>
    <script src="js/simple-error-handler.js" defer></script>
    
    <script defer>
        window.addEventListener('DOMContentLoaded', async () => {
            const output = document.getElementById('output');
            const log = [];
            
            const addLog = (msg, className = '') => {
                const line = document.createElement('div');
                line.className = className;
                line.textContent = msg;
                output.appendChild(line);
                console.log(msg);
            };
            
            addLog('=== Testing DataLoader Error Details ===\n');
            
            // Wait a bit for all scripts to load
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Check what's available
            addLog('Checking modules...');
            addLog(`DataLoader: ${typeof window.DataLoader !== 'undefined' ? '✓' : '✗'}`);
            addLog(`DataNormalizer: ${typeof window.DataNormalizer !== 'undefined' ? '✓' : '✗'}`);
            addLog(`SimpleErrorHandler: ${typeof window.simpleErrorHandler !== 'undefined' ? '✓' : '✗'}`);
            
            if (typeof window.DataLoader === 'undefined') {
                addLog('\nERROR: DataLoader not loaded!', 'error');
                return;
            }
            
            addLog('\n--- Creating DataLoader ---');
            const dataLoader = new window.DataLoader({
                validateDuringLoad: true,
                maxRetries: 1
            });
            
            // Add event listeners to track what's happening
            dataLoader.on('loading-start', (e) => addLog(`Event: loading-start`));
            dataLoader.on('loading-error', (e) => addLog(`Event: loading-error - ${e.error.message}`, 'error'));
            dataLoader.on('loading-complete', (e) => addLog(`Event: loading-complete`, 'success'));
            dataLoader.on('status-update', (e) => addLog(`Event: status-update - ${e.type}: ${e.status}`));
            dataLoader.on('validation-error', (e) => addLog(`Event: validation-error`, 'error'));
            dataLoader.on('validation-warning', (e) => addLog(`Event: validation-warning`));
            dataLoader.on('fallback-loading', (e) => addLog(`Event: fallback-loading`));
            
            addLog('\n--- Attempting loadAll() ---');
            
            try {
                const result = await dataLoader.loadAll();
                addLog('\nSUCCESS! Data loaded:', 'success');
                addLog(`- Tools: ${result.tools ? result.tools.length : 0}`);
                addLog(`- Categories: ${result.categories ? result.categories.length : 0}`);
                addLog(`- Stats: ${result.stats ? 'present' : 'missing'}`);
                addLog(`- Is Mock Data: ${result.isMockData ? 'YES' : 'NO'}`);
                
            } catch (error) {
                addLog('\nERROR in loadAll():', 'error');
                addLog(`Message: ${error.message}`, 'error');
                addLog(`\nStack trace:`, 'error');
                addLog(error.stack, 'error');
                
                // Try individual loads to see which one fails
                addLog('\n--- Testing individual loads ---');
                
                try {
                    const tools = await dataLoader.loadToolsData();
                    addLog(`✓ Tools loaded: ${tools ? tools.length : 0}`, 'success');
                } catch (e) {
                    addLog(`✗ Tools failed: ${e.message}`, 'error');
                }
                
                try {
                    const categories = await dataLoader.loadCategoriesData();
                    addLog(`✓ Categories loaded: ${categories ? categories.length : 0}`, 'success');
                } catch (e) {
                    addLog(`✗ Categories failed: ${e.message}`, 'error');
                }
                
                try {
                    const stats = await dataLoader.loadStatsData();
                    addLog(`✓ Stats loaded: ${stats ? 'yes' : 'no'}`, 'success');
                } catch (e) {
                    addLog(`✗ Stats failed: ${e.message}`, 'error');
                }
            }
        });
    </script>
</body>
</html>