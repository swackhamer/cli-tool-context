<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Data Types</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .error { color: red; }
        .warning { color: orange; }
        .success { color: green; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>Data Type Analysis</h1>
    <div id="output"></div>
    
    <script>
        async function analyzeDataTypes() {
            const output = document.getElementById('output');
            const log = [];
            
            const addLog = (msg, className = '') => {
                const div = document.createElement('div');
                div.className = className;
                div.textContent = msg;
                output.appendChild(div);
            };
            
            try {
                // Fetch tools data
                const response = await fetch('data/tools.json');
                const data = await response.json();
                const tools = data.tools || [];
                
                addLog(`Analyzing ${tools.length} tools...`, 'success');
                
                // Track type issues
                const typeIssues = {
                    installation: [],
                    difficulty: [],
                    platform: [],
                    tags: []
                };
                
                tools.forEach((tool, index) => {
                    // Check installation field
                    if (tool.installation !== undefined && tool.installation !== null) {
                        if (typeof tool.installation !== 'string') {
                            typeIssues.installation.push({
                                id: tool.id,
                                type: typeof tool.installation,
                                isArray: Array.isArray(tool.installation),
                                value: tool.installation
                            });
                        }
                    }
                    
                    // Check difficulty field
                    if (tool.difficulty !== undefined && tool.difficulty !== null) {
                        if (typeof tool.difficulty !== 'number') {
                            typeIssues.difficulty.push({
                                id: tool.id,
                                type: typeof tool.difficulty,
                                value: tool.difficulty
                            });
                        }
                    }
                    
                    // Check platform field (should be array or string)
                    if (tool.platform !== undefined && tool.platform !== null) {
                        if (typeof tool.platform !== 'string' && !Array.isArray(tool.platform)) {
                            typeIssues.platform.push({
                                id: tool.id,
                                type: typeof tool.platform,
                                value: tool.platform
                            });
                        }
                    }
                    
                    // Check tags field (should be array)
                    if (tool.tags !== undefined && tool.tags !== null) {
                        if (!Array.isArray(tool.tags)) {
                            typeIssues.tags.push({
                                id: tool.id,
                                type: typeof tool.tags,
                                value: tool.tags
                            });
                        }
                    }
                });
                
                // Report findings
                addLog('\n=== Type Analysis Results ===\n');
                
                for (const [field, issues] of Object.entries(typeIssues)) {
                    if (issues.length > 0) {
                        addLog(`\n${field.toUpperCase()} field issues (${issues.length}):`, 'warning');
                        issues.slice(0, 5).forEach(issue => {
                            addLog(`  ${issue.id}: ${issue.type}${issue.isArray ? ' (array)' : ''} = ${JSON.stringify(issue.value).substring(0, 50)}`);
                        });
                        if (issues.length > 5) {
                            addLog(`  ... and ${issues.length - 5} more`);
                        }
                    } else {
                        addLog(`${field}: âœ“ All values have correct type`, 'success');
                    }
                }
                
                // Check for tools with multiple type issues
                const problemTools = new Set();
                Object.values(typeIssues).forEach(issues => {
                    issues.forEach(issue => problemTools.add(issue.id));
                });
                
                if (problemTools.size > 0) {
                    addLog(`\n=== Tools with type issues: ${problemTools.size} ===`, 'warning');
                    Array.from(problemTools).slice(0, 10).forEach(id => {
                        addLog(`  - ${id}`);
                    });
                }
                
                // Check if tools are being modified during normalization
                addLog('\n=== Checking for runtime modifications ===');
                
                // Sample a few tools and check their types
                const sampleTools = tools.slice(0, 5);
                sampleTools.forEach(tool => {
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify({
                        id: tool.id,
                        installation: {
                            value: tool.installation,
                            type: typeof tool.installation,
                            isArray: Array.isArray(tool.installation)
                        },
                        difficulty: {
                            value: tool.difficulty,
                            type: typeof tool.difficulty
                        }
                    }, null, 2);
                    output.appendChild(pre);
                });
                
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Run analysis when page loads
        window.addEventListener('DOMContentLoaded', analyzeDataTypes);
    </script>
</body>
</html>